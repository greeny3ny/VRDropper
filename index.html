<!DOCTYPE html>
<html>
	<body>
	<script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
	<script src="https://sdk.altvr.com/libs/altspace.js/2.8.1/altspace.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.2.0/firebase.js"></script>

	<script>
		AFRAME.registerComponent('box_collide',
		{
			schema:  //does stuff
			{ 
				jointCubeSize: {
				  type: 'float',
				  default: 0.275
				},
				box_id:{type: 'int'},
				box_integrity:{type: 'int'}
			},
			  init: function ()
			{
				var self = this;
				var object = self.el.object3D;
				
				var id = self.data.box_id;
				var integrity = self.data.box_integrity;
				
				object.addBehavior(new altspace.utilities.behaviors.JointCollisionEvents
								   ({
				  joints: [['Head', 'Center', 0]], jointCubeSize: self.data.jointCubeSize
				}));
				
				//joints enter
				object.addEventListener('jointcollisionenter', handleJoin);		
				function handleJoin(event)
				{
					console.log("box " + id);
					console.log("integrity drop");
					self.data.box_integrity --;
					console.log("integrity now at " + integrity);
					
					
					setTextures();
				}// end function handle join
				
				//joint collision leave
				object.addEventListener('jointcollisionleave', handleLeave);
				function handleLeave(event)
				{
				}//end function handle leave
			}
		}); //end base collision
	</script>
	
	<a-scene altspace="fullspace:true;">
	
		<a-assets>
			<img id='i1' src='assets/integrity1.png'/>
			<img id='i2' src='assets/integrity2.png'/>
			<img id='i3' src='assets/integrity3.png'/>
			<img id='i4' src='assets/integrity4.png'/>
		</a-assets>
		
	</a-scene>
	
	</body>
	
	<script>
	
		const sim = new altspace.utilities.Simulation();
		const scene = document.querySelector('a-scene');
		const DB_REF = new Firebase("https://vrmazemaker.firebaseio.com");
		const SCALE = 2;
		const SIZE = 10;
		
		var objects = [];
		var objectsCollider = [];
		//=====================================================
		
		main();
		
		function main(){
			console.log("Main");
			setUpTiles();
			setUpColliders();
		}
		
		function setUpTiles(){
			
			for(var x=0; x<SIZE; x++){
				for(var z=0; z<SIZE; z++){
					var tile = document.createElement('a-box');
					tile.setAttribute('position', x*SCALE+' 1 '+z*SCALE);
					tile.setAttribute('scale', SCALE + ' 1 ' + SCALE);
					tile.setAttribute('src', '#i4');
					tile.setAttribute('n-mesh-collider', 'type:environment');
					tile.setAttribute('box_collide','box_id:'+(x+(z*SIZE))+';box_integrity:4;');
					objects.push(tile);
					scene.appendChild(tile);
				}
			}
		
		}
		
		function setUpColliders(){
			for(var x=0; x<SIZE; x++){
				for(var z=0; z<SIZE; z++){
					var colliderTile = document.createElement('a-box');
					colliderTile.setAttribute('position', x*SCALE+' 4 '+z*SCALE);
					colliderTile.setAttribute('scale', SCALE + ' 2 ' + SCALE);
					colliderTile.setAttribute('color', 'green');
					colliderTile.setAttribute('opacity', '0');
					colliderTile.setAttribute('n-mesh-collider', 'type:hologram');
					colliderTile.setAttribute('box_collide','box_id:'+(x+(z*SIZE))+';box_integrity:4;');
					objectsCollider.push(colliderTile);
					scene.appendChild(colliderTile);
				}
			}
		}
		
		function setTextures(){
			for (var i=0; i<10; i++){
				for (var j=0; j<10; j++){
					//console.log(objectsCollider[i+(j*SIZE)].getAttribute('box_collide').box_integrity);
					switch(objectsCollider[i+(j*SIZE)].getAttribute('box_collide').box_integrity){
						case 1:
							objects[i+(j*SIZE)].setAttribute('src','#i1');
						break;
						case 2:
							objects[i+(j*SIZE)].setAttribute('src','#i2');
						break;
						case 3:
							objects[i+(j*SIZE)].setAttribute('src','#i3');
						break;
						case 4:
							objects[i+(j*SIZE)].setAttribute('src','#i4');
						break;
						case 0:
							objects[i+(j*SIZE)].setAttribute('position','-10 -10 -10');
						break;
						
					}
					
					
				}
			}
			
		}
		
		//run this 5 times every second??
		function ticker(){
			
			//console.log("weeeeeee");
			updateDatabase();
			
		}
		
		function updateDatabase(){
			console.log("updating database!");
		}
		
		
</script>