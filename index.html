<!DOCTYPE html>
<html>
	<body>
	<script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
	<script src="https://sdk.altvr.com/libs/altspace.js/2.8.1/altspace.min.js"></script>
	
	<script src="https://www.gstatic.com/firebasejs/5.3.0/firebase.js"></script>
	<script>
	  // Initialize Firebase
	  var config = {
		apiKey: "AIzaSyCrbi8d75jgcxpBa5ghJa01JekEhfU1P9U",
		authDomain: "vrdropper.firebaseapp.com",
		databaseURL: "https://vrdropper.firebaseio.com",
		projectId: "vrdropper",
		storageBucket: "vrdropper.appspot.com",
		messagingSenderId: "380509338142"
	  };
	  firebase.initializeApp(config);
	</script>

	<script>
		AFRAME.registerComponent('box_collide',
		{
			schema:  //does stuff
			{ 
				jointCubeSize: {
				  type: 'float',
				  default: 0.275
				},
				box_id:{type: 'int'},
				box_integrity:{type: 'int'}
			},
			  init: function ()
			{
				var self = this;
				var object = self.el.object3D;
				
				var id = self.data.box_id;
				var integrity = self.data.box_integrity;
				
				object.addBehavior(new altspace.utilities.behaviors.JointCollisionEvents
								   ({
				  joints: [['Head', 'Center', 0]], jointCubeSize: self.data.jointCubeSize
				}));
				
				//joints enter
				object.addEventListener('jointcollisionenter', handleJoin);		
				function handleJoin(event)
				{
					console.log("box " + id);
					console.log("integrity drop");
					self.data.box_integrity --;
					console.log("integrity now at " + self.data.box_integrity);
					//updateFirebase(objectNode[id]);
					
					console.log("node : "+ objectNode[id]);
					updateFirebase(objectNode[id], self.data.box_integrity);
					
					
					setTextures();
				}// end function handle join
				
				//joint collision leave
				object.addEventListener('jointcollisionleave', handleLeave);
				function handleLeave(event)
				{
				}//end function handle leave
			}
		}); //end base collision
	</script>
	
	<a-scene altspace="fullspace:true;">
	
		<a-assets>
			<img id='i1' src='assets/integrity1.png'/>
			<img id='i2' src='assets/integrity2.png'/>
			<img id='i3' src='assets/integrity3.png'/>
			<img id='i4' src='assets/integrity4.png'/>
		</a-assets>
		
		<a-entity id="version" position='-20 15 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
		
	</a-scene>
	
	</body>
	
	<script>
	
		const VERSION = "0.2.0";
		
		const sim = new altspace.utilities.Simulation();
		const scene = document.querySelector('a-scene');
		const DB_REF = new Firebase("https://vrdropper.firebaseio.com");
		const SCALE = 2;
		const SIZE = 10;
		
		var objects = [];
		var objectNode = [];
		var objectsCollider = [];
		
		var resetDetector = true;
		//=====================================================
		var box1Geo = new THREE.BoxGeometry(1, 1, 1); 
		var bTex = new THREE.ImageUtils.loadTexture("assets/test.png");
		var bMat = new THREE.MeshBasicMaterial({ 
			map:bTex, 
			side:THREE.DoubleSide 
		}); 
		var restartBox = new THREE.Mesh(box1Geo, bMat);
		restartBox.position.set(-10, 0, -10);
		sim.scene.add(restartBox);
		//
		document.querySelector('#version').setAttribute('n-text','text: Version : ' + VERSION);
		main();
		DB_REF.child("reset").on("child_changed", function(snapshot){
			resetDetector = snapshot.val();
			resetGame();
		});
		
		function main(){
			console.log("Main");
			
			readFirebaseTest();
		}
		
		function setUpTiles(){
			
			for(var x=0; x<SIZE; x++){
				for(var z=0; z<SIZE; z++){
					var tile = document.createElement('a-box');
					tile.setAttribute('position', x*SCALE+' 1 '+z*SCALE);
					tile.setAttribute('scale', SCALE + ' 1 ' + SCALE);
					tile.setAttribute('src', '#i4');
					tile.setAttribute('n-mesh-collider', 'type:environment');
					tile.setAttribute('box_collide','box_id:'+(x+(z*SIZE))+';box_integrity:4;');

					objects.push(tile);
					scene.appendChild(tile);
					
					//console.log("applepie");
				}
			}
			
			
			//why am i doing this here??/
			try{
				for (var i=0; i<SIZE*SIZE; i++){
					readFirebase(objectNode[i]);
				}
			}catch(e){}
		}
		
		function setUpColliders(){
			for(var x=0; x<SIZE; x++){
				for(var z=0; z<SIZE; z++){
					var colliderTile = document.createElement('a-box');
					colliderTile.setAttribute('position', x*SCALE+' 4 '+z*SCALE);
					colliderTile.setAttribute('scale', SCALE + ' 2 ' + SCALE);
					colliderTile.setAttribute('color', 'green');
					colliderTile.setAttribute('opacity', '0');
					colliderTile.setAttribute('n-mesh-collider', 'type:hologram');
					colliderTile.setAttribute('box_collide','box_id:'+(x+(z*SIZE))+';box_integrity:4;');
					objectsCollider.push(colliderTile);
					scene.appendChild(colliderTile);
				}
			}
		}
		
		function setTextures(){
			for (var i=0; i<SIZE; i++){
				for (var j=0; j<SIZE; j++){
					setTextureSingle(i+(j*SIZE));
				}
			}
		}
		
		function setTextureSingle(boxId){
			console.log("Setting texture of box " + boxId);
			console.log(objectsCollider[boxId].getAttribute('box_integrity'));
			switch(parseInt(objectsCollider[boxId].getAttribute('box_integrity'))){
				case 1:
					objects[boxId].setAttribute('src','#i1');
				break;
				case 2:
					objects[boxId].setAttribute('src','#i2');
				break;
				case 3:
					console.log("banana");
					objects[boxId].setAttribute('src','#i3');
				break;
				case 4:
					objects[boxId].setAttribute('src','#i4');
				break;
				case 0:
					objects[boxId].setAttribute('position','-10 -10 -10');
				break;	
			}
		}
		
		function wipeFirebase(){
			DB_REF.child("tiles").remove();
			console.log("firebase wiped!");
		}
		
		function writeFirebase(bint){
			//console.log("writing to firebase " + bint);
			var tileKey = DB_REF.child("tiles").push({integrity: bint}).key();
			objectNode.push(tileKey);
		}
		
		function updateFirebase(key, bint){
			DB_REF.child("tiles").child(key).update({integrity: bint});
		}
		
		function readFirebase(key){
			var test;
			DB_REF.child("tiles").child(key).on("value", function(snapshot){
				test = snapshot.val();
				//console.log("child changed!");
				//console.log(test.integrity);
				//console.log(objectNode.indexOf(key));
				console.log(" ");
				objectsCollider[objectNode.indexOf(key)].setAttribute('box_integrity',test.integrity);
				console.log(objectsCollider[objectNode.indexOf(key)].getAttribute('box_integrity'));
				//objectsCollider[objectNode.indexOf(key)].getAttribute('box_integrity')
				//objectsCollider[boxId].getAttribute('box_integrity')
				
				
				//console.log(objectsCollider[objectNode.indexOf(key)].getAttribute('box_integrity'));
				setTextureSingle(objectNode.indexOf(key));
			});
		}
		
		function readFirebaseTest(){
			console.log("initial firebase read");
			var temp;
			setUpTiles();
			setUpColliders();
			DB_REF.child("tiles").on("value", function(snapshot){
				temp = snapshot.val();
			});
			
			setTimeout(function(){
				console.log("test");
				try{
					for (var i=0; i<SIZE*SIZE; i++){
						objectNode.push(Object.keys(temp)[i]);
						readFirebase(objectNode[i]);
					}
				}catch(e){}	
			console.log(objectNode);
				
			},1000);
			
			

			
		}
		
		//maybe not need an extra function for this?
		function resetGame(){
			for (var i=0; i<objects.length; i++) {
				scene.removeChild(objects[i]);
				scene.removeChild(objectsCollider[i]);
			}
			objects = [];
			objectsCollider = [];
			objectNode = [];
			
			main();
		}
		
		restartBox.addEventListener('cursordown', function(){
			console.log("resetBox clicked!");
			resetDetector = !resetDetector;
			DB_REF.child("reset").update({res:resetDetector});
			//wipeFirebase();
			for (var i=0; i<SIZE*SIZE; i++){
				//writeFirebase(4);
			}
			
			
		});
		
		
</script>